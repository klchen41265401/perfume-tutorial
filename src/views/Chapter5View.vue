<template>
  <ChapterLayout
    title="ç¬¬5ç« ï¼šé…æ–¹å·¥ç¨‹"
    :prev="{ to: '/chapter/4', label: 'ç¬¬4ç« ï¼šåˆæˆ' }"
    :next="{ to: '/chapter/6', label: 'ç¬¬6ç« ï¼šåˆ†ææ–¹æ³•' }"
    :sections="sections"
    :active-section="activeSection"
    @update:activeSection="activeSection = $event"
  >
    <div class="chapter-sections">
      <section v-show="activeSection === 'sec-5-1'" class="chapter-section">
        <h2 id="sec-5-1">5.1 æ®ç™¼æ›²ç·šçš„å¾®åˆ†æ–¹ç¨‹</h2>
        <h3>5.1.1 å–®çµ„åˆ†æ®ç™¼æ¨¡å‹</h3>
        <p>é¦™æ–™åˆ†å­çš„æ®ç™¼éç¨‹å— Fick ç¬¬äºŒå®šå¾‹æ”¯é…ï¼š</p>
        <pre><code>âˆ‚C/âˆ‚t = DÂ·âˆ‚Â²C/âˆ‚xÂ² - vÂ·âˆ‚C/âˆ‚x - kÂ·C

C(x,t): æ¿ƒåº¦åˆ†ä½ˆ (mol/mÂ³)
D: æ“´æ•£ä¿‚æ•¸ (mÂ²/s), v: å°æµé€Ÿåº¦ (m/s), k: æ®ç™¼é€Ÿç‡å¸¸æ•¸ (sâ»Â¹)

é‚Šç•Œæ¢ä»¶ï¼š
C(0,t) = Câ‚€, C(âˆ,t) = 0, C(x,0) = 0

ç©©æ…‹è¿‘ä¼¼è§£ï¼š
C(x,t) = Câ‚€Â·exp(-âˆš(k/D)Â·x)Â·[1 - erf(x/âˆš(4Dt))]</code></pre>

        <h3>5.1.2 å¤šçµ„åˆ†ç«¶çˆ­æ®ç™¼</h3>
        <div class="chart-container"><canvas ref="evaporationChart" style="max-height: 320px;"></canvas></div>
      </section>

      <section v-show="activeSection === 'sec-5-2'" class="chapter-section">
        <h2 id="sec-5-2">5.2 å¤šçµ„åˆ†æ“´æ•£æ¨¡å‹</h2>
        <h3>5.2.1 Maxwell-Stefanæ–¹ç¨‹</h3>
        <p>å°æ–¼æ¿ƒç¸®é¦™ç²¾ï¼Œçµ„åˆ†é–“ç›¸äº’ä½œç”¨ä¸å¯å¿½ç•¥ï¼š</p>
        <pre><code>âˆ‡(Î¼áµ¢) = RTÂ·âˆ‘â±¼ (xâ±¼Náµ¢ - xáµ¢Nâ±¼) / (câ‚œÂ·Ãáµ¢â±¼)

ç°¡åŒ–ç‚ºFickå‹ï¼šNáµ¢ = -câ‚œÂ·âˆ‘â±¼ Dáµ¢â±¼Â·âˆ‡xâ±¼
[D] = [Î“]Â·[Ã]Â·[Î“]â»Â¹
Î“áµ¢â±¼ = Î´áµ¢â±¼ + xáµ¢Â·(âˆ‚ln(Î³áµ¢)/âˆ‚xâ±¼)</code></pre>

        <h3>5.2.2 æ´»åº¦ä¿‚æ•¸è¨ˆç®—ï¼šUNIFACæ¨¡å‹</h3>
        <pre><code>ln(Î³_i) = ln(Î³_i_C) + ln(Î³_i_R)
çµ„åˆé …ï¼šStaverman-Guggenheim
æ®˜é¤˜é …ï¼šå®˜èƒ½åœ˜äº¤äº’ä½œç”¨

UNIFACå®˜èƒ½åœ˜åƒæ•¸ï¼š
CHâ‚ƒ: R=0.9011, Q=0.848
CHâ‚‚: R=0.6744, Q=0.540
OH:  R=1.0000, Q=1.200
CHO: R=0.9980, Q=0.948</code></pre>
      </section>

      <section v-show="activeSection === 'sec-5-3'" class="chapter-section">
        <h2 id="sec-5-3">5.3 å„ªåŒ–ç®—æ³•ï¼šé…æ–¹è‡ªå‹•è¨­è¨ˆ</h2>
        <h3>5.3.1 ç›®æ¨™å‡½æ•¸å®šç¾©</h3>
        <pre><code>ç›®æ¨™1ï¼šæ®ç™¼æ›²ç·šåŒ¹é…  fâ‚(x) = âˆ‘áµ¢ âˆ‘â‚œ [Cáµ¢(t;x) - Cáµ¢,target(t)]Â²
ç›®æ¨™2ï¼šæˆæœ¬æœ€å°åŒ–    fâ‚‚(x) = âˆ‘áµ¢ xáµ¢ Â· priceáµ¢
ç›®æ¨™3ï¼šç©©å®šæ€§        fâ‚ƒ(x) = -min(shelf_life(x))

ç´„æŸï¼šâˆ‘xáµ¢ = 1, xáµ¢ â‰¥ 0, safety_indexáµ¢ â‰¤ threshold</code></pre>
        <div class="chart-container"><canvas ref="paretoChart" style="max-height: 320px;"></canvas></div>

        <h3>5.3.2 éºå‚³ç®—æ³•å¯¦ç¾</h3>
        <pre><code>NSGA-II å¤šç›®æ¨™éºå‚³ç®—æ³•ï¼š
1. åˆå§‹åŒ–ç¨®ç¾¤ (200å€‹é«”)
2. äº¤å‰æ¦‚ç‡ 0.7 (Blend)
3. çªè®Šæ¦‚ç‡ 0.3 (Gaussian Ïƒ=0.1)
4. é¸æ“‡ï¼šéæ”¯é…æ’åº + æ“æ“ è·é›¢
5. è¿­ä»£ 100 ä»£
â†’ è¼¸å‡º Pareto å‰æ²¿è§£é›†</code></pre>
      </section>

      <section v-show="activeSection === 'sec-5-4'" class="chapter-section">
        <h2 id="sec-5-4">5.4 äº’å‹•å¼é…æ–¹è¨ˆç®—å™¨</h2>
        <div class="attention-box">
          <h4>ğŸ§ª å¯¦æ™‚é…æ–¹è¨­è¨ˆå·¥å…·</h4>
          <p>èª¿æ•´å„æˆåˆ†æ¯”ä¾‹ï¼ŒæŸ¥çœ‹é æ¸¬çš„æ®ç™¼æ›²ç·šï¼š</p>
          <div class="slider-group">
            <label>Citrus oil: <strong>{{ citrus }}%</strong></label>
            <input type="range" min="0" max="30" v-model.number="citrus" />
          </div>
          <div class="slider-group">
            <label>Linalool: <strong>{{ linalool }}%</strong></label>
            <input type="range" min="0" max="40" v-model.number="linalool" />
          </div>
          <div class="slider-group">
            <label>Rose oxide: <strong>{{ rose }}%</strong></label>
            <input type="range" min="0" max="30" v-model.number="rose" />
          </div>
          <div class="slider-group">
            <label>Sandalwood: <strong>{{ sandalwood }}%</strong></label>
            <input type="range" min="0" max="40" v-model.number="sandalwood" />
          </div>
          <div class="slider-group">
            <label>Musk: <strong>{{ musk }}%</strong></label>
            <input type="range" min="0" max="30" v-model.number="musk" />
          </div>
          <p>ç¸½è¨ˆï¼š<strong :style="{ color: Math.abs(totalPct - 100) > 5 ? '#ef4444' : '#4ade80' }">{{ totalPct }}%</strong>
            <span v-if="Math.abs(totalPct - 100) > 5" style="color: #ef4444;"> âš ï¸ ç¸½è¨ˆæ‡‰æ¥è¿‘100%</span>
          </p>
          <button class="btn-primary" @click="updateFormulation">è¨ˆç®—æ®ç™¼æ›²ç·š</button>
        </div>
        <div class="chart-container"><canvas ref="customFormulaChart" style="max-height: 320px;"></canvas></div>
      </section>

      <section v-show="activeSection === 'sec-5-5'" class="chapter-section">
        <h2 id="sec-5-5">5.5 æˆæœ¬-æ•ˆèƒ½æ¬Šè¡¡åˆ†æ</h2>
        <h3>5.5.1 åƒ¹å€¼å·¥ç¨‹çŸ©é™£</h3>
        <pre><code>Value Index = Performance Score / Cost
Performance Score = wâ‚Â·Longevity + wâ‚‚Â·Intensity + wâ‚ƒÂ·Complexity

å¥¢ä¾ˆå“ç‰Œ: VI < 0.5
è¼•å¥¢å“ç‰Œ: 0.5 â‰¤ VI â‰¤ 2.0
å¤§çœ¾å“ç‰Œ: VI > 2.0</code></pre>
        <div class="chart-container"><canvas ref="valueChart" style="max-height: 320px;"></canvas></div>

        <h2>ğŸ“š å»¶ä¼¸é–±è®€</h2>
        <ul>
          <li>Taylor, R. & Krishna, R. (1993). <em>Multicomponent Mass Transfer</em>. Wiley.</li>
          <li>Deb, K. et al. (2002). "NSGA-II". <em>IEEE Trans. Evol. Comput.</em> 6, 182-197.</li>
          <li>Fredenslund, A. et al. (1975). "UNIFAC". <em>AIChE J.</em> 21, 1086-1099.</li>
        </ul>
      </section>
    </div>
  </ChapterLayout>
</template>

<script>
import { ref, computed, onMounted, onUnmounted, watch, nextTick } from 'vue'
import { Chart } from 'chart.js/auto'
import ChapterLayout from '../components/ChapterLayout.vue'

export default {
  name: 'Chapter5View',
  components: { ChapterLayout },
  setup() {
    const evaporationChart = ref(null)
    const paretoChart = ref(null)
    const customFormulaChart = ref(null)
    const valueChart = ref(null)
    let charts = []
    let formulaChart = null

    const citrus = ref(15)
    const linalool = ref(25)
    const rose = ref(20)
    const sandalwood = ref(25)
    const musk = ref(15)
    const totalPct = computed(() => citrus.value + linalool.value + rose.value + sandalwood.value + musk.value)

    const sections = [
      { id: 'sec-5-1', label: '5.1' },
      { id: 'sec-5-2', label: '5.2' },
      { id: 'sec-5-3', label: '5.3' },
      { id: 'sec-5-4', label: '5.4' },
      { id: 'sec-5-5', label: '5.5' }
    ]
    const activeSection = ref(sections[0].id)

    function updateFormulation() {
      if (!customFormulaChart.value) return
      const times = []
      for (let t = 0; t <= 12; t += 0.1) times.push(t)
      const data = times.map(t => {
        return (citrus.value / 100) * 9 * Math.exp(-0.30 * t) +
               (linalool.value / 100) * 7 * Math.exp(-0.15 * t) +
               (rose.value / 100) * 8 * Math.exp(-0.10 * t) +
               (sandalwood.value / 100) * 6 * Math.exp(-0.03 * t) +
               (musk.value / 100) * 5 * Math.exp(-0.005 * t)
      })
      if (formulaChart) {
        formulaChart.data.labels = times.map(t => t.toFixed(1))
        formulaChart.data.datasets[0].data = data
        formulaChart.update()
      } else {
        formulaChart = new Chart(customFormulaChart.value, {
          type: 'line',
          data: {
            labels: times.map(t => t.toFixed(1)),
            datasets: [{ label: 'ç¸½é«”é¦™æ°£å¼·åº¦', data, borderColor: 'rgb(255,99,132)', backgroundColor: 'rgba(255,99,132,0.1)', fill: true, tension: 0.3, borderWidth: 2, pointRadius: 0 }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#cbd5e1' } }, title: { display: true, text: 'è‡ªå®šç¾©é…æ–¹æ®ç™¼æ›²ç·šé æ¸¬', color: '#d4af37', font: { size: 18 } } },
            scales: {
              y: { min: 0, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(51,65,85,0.3)' }, title: { display: true, text: 'é¦™æ°£å¼·åº¦', color: '#cbd5e1' } },
              x: { max: 12, ticks: { color: '#94a3b8', maxTicksLimit: 13 }, grid: { color: 'rgba(51,65,85,0.3)' }, title: { display: true, text: 'æ™‚é–“ (å°æ™‚)', color: '#cbd5e1' } }
            }
          }
        })
      }
    }

    onMounted(() => {
      // Evaporation chart
      if (evaporationChart.value) {
        const times = []; for (let t = 0; t <= 12; t += 0.1) times.push(t)
        const mkData = (k, s) => times.map(t => s * Math.exp(-k * t))
        charts.push(new Chart(evaporationChart.value, {
          type: 'line',
          data: {
            labels: times.map(t => t.toFixed(1)),
            datasets: [
              { label: 'Limonene (å‰èª¿)', data: mkData(0.32, 10), borderColor: 'rgb(255,206,86)', borderWidth: 2, pointRadius: 0, tension: 0.3 },
              { label: 'Linalool (ä¸­èª¿)', data: mkData(0.15, 8), borderColor: 'rgb(75,192,192)', borderWidth: 2, pointRadius: 0, tension: 0.3 },
              { label: 'Coumarin (åŸºèª¿)', data: mkData(0.02, 6), borderColor: 'rgb(153,102,255)', borderWidth: 2, pointRadius: 0, tension: 0.3 },
              { label: 'Musk (åŸºèª¿)', data: mkData(0.001, 5), borderColor: 'rgb(255,99,132)', borderWidth: 2, pointRadius: 0, tension: 0.3 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#cbd5e1' } }, title: { display: true, text: 'å¤šçµ„åˆ†é¦™æ°´æ®ç™¼å‹•åŠ›å­¸æ›²ç·š', color: '#d4af37', font: { size: 18 } } },
            scales: {
              y: { min: 0, max: 11, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(51,65,85,0.3)' }, title: { display: true, text: 'ç›¸å°å¼·åº¦', color: '#cbd5e1' } },
              x: { ticks: { color: '#94a3b8', maxTicksLimit: 13 }, grid: { color: 'rgba(51,65,85,0.3)' }, title: { display: true, text: 'æ™‚é–“ (å°æ™‚)', color: '#cbd5e1' } }
            }
          }
        }))
      }
      // Pareto chart
      if (paretoChart.value) {
        charts.push(new Chart(paretoChart.value, {
          type: 'scatter',
          data: {
            datasets: [{ label: 'Paretoæœ€å„ªè§£', data: [{x:0.5,y:120},{x:0.8,y:95},{x:1.2,y:75},{x:1.8,y:55},{x:2.5,y:40},{x:3.2,y:32},{x:4.0,y:28}], backgroundColor: 'rgb(75,192,192)', borderColor: 'rgb(75,192,192)', pointRadius: 8, pointHoverRadius: 12 }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#cbd5e1' } }, title: { display: true, text: 'æˆæœ¬ vs è¼ªå»“èª¤å·® Paretoå‰æ²¿', color: '#d4af37', font: { size: 18 } } },
            scales: {
              x: { min: 0, max: 5, title: { display: true, text: 'è¼ªå»“èª¤å·® (RMSE)', color: '#cbd5e1' }, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(51,65,85,0.3)' } },
              y: { min: 0, max: 150, title: { display: true, text: 'æˆæœ¬ ($/100g)', color: '#cbd5e1' }, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(51,65,85,0.3)' } }
            }
          }
        }))
      }
      // Value chart
      if (valueChart.value) {
        charts.push(new Chart(valueChart.value, {
          type: 'scatter',
          data: {
            datasets: [
              { label: 'å¥¢ä¾ˆå“ç‰Œ', data: [{x:8.5,y:180},{x:9.0,y:250},{x:8.8,y:320}], backgroundColor: 'rgb(255,206,86)', pointRadius: 10 },
              { label: 'è¼•å¥¢å“ç‰Œ', data: [{x:7.5,y:85},{x:8.0,y:110},{x:7.8,y:95}], backgroundColor: 'rgb(75,192,192)', pointRadius: 10 },
              { label: 'å¤§çœ¾å“ç‰Œ', data: [{x:6.0,y:25},{x:6.5,y:35},{x:5.8,y:30}], backgroundColor: 'rgb(153,102,255)', pointRadius: 10 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#cbd5e1' } }, title: { display: true, text: 'å¸‚å ´å®šä½ï¼šæ€§èƒ½ vs æˆæœ¬åˆ†æ', color: '#d4af37', font: { size: 18 } } },
            scales: {
              x: { min: 5, max: 10, title: { display: true, text: 'æ€§èƒ½è©•åˆ† (0-10)', color: '#cbd5e1' }, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(51,65,85,0.3)' } },
              y: { min: 0, max: 350, title: { display: true, text: 'æˆæœ¬ ($/100ml)', color: '#cbd5e1' }, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(51,65,85,0.3)' } }
            }
          }
        }))
      }
      // Init custom formula chart
      updateFormulation()
    })
    watch(activeSection, async () => {
      await nextTick()
      charts.forEach(chart => chart.resize())
      if (formulaChart) formulaChart.resize()
    })
    onUnmounted(() => { charts.forEach(c => c.destroy()); if (formulaChart) formulaChart.destroy() })

    return { evaporationChart, paretoChart, customFormulaChart, valueChart, citrus, linalool, rose, sandalwood, musk, totalPct, updateFormulation, sections, activeSection }
  }
}
</script>
